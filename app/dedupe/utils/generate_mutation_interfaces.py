#!/usr/bin/env python3

"""
Generate Protocol interface classes from LinkML mutation definitions.

This utility reads def/mutations.yml and generates Protocol classes that define
the interface for mutation implementations. This allows multiple implementations
(different storage backends, mock implementations) to be type-checked against the same schema.
"""

import yaml
from pathlib import Path
from typing import Dict, List, Tuple


def parse_mutations_yaml(yaml_path: Path) -> Dict:
    with open(yaml_path) as f:
        return yaml.safe_load(f)


def find_mutation_pairs(schema: Dict) -> List[Tuple[str, str]]:
    """Find pairs of Input/Output mutation classes."""
    classes = schema.get('classes', {})
    pairs = []

    for class_name in classes:
        if class_name.endswith('Input'):
            # Find corresponding output class (remove 'Input' suffix)
            output_name = class_name[:-5]  # Remove 'Input'
            if output_name in classes:
                pairs.append((class_name, output_name))

    return pairs


def generate_protocol_file(schema: Dict, output_path: Path):
    """Generate a Python file with Protocol interfaces."""
    pairs = find_mutation_pairs(schema)

    lines = [
        '"""',
        'Auto-generated Protocol interfaces for mutation implementations.',
        '',
        'DO NOT EDIT THIS FILE MANUALLY.',
        'Generated from def/mutations.yml by utils/generate_mutation_interfaces.py',
        '"""',
        '',
        'from typing import Protocol',
        'from gen.mutations import (',
    ]

    # Import all Input and Output classes
    for input_class, output_class in pairs:
        lines.append(f'    {input_class},')
        lines.append(f'    {output_class},')

    lines.append(')')
    lines.append('')
    lines.append('')

    # Generate Protocol for each mutation pair
    for input_class, output_class in pairs:
        protocol_name = f'{output_class}Protocol'
        lines.append(f'class {protocol_name}(Protocol):')
        lines.append(f'    """Protocol for {output_class} mutation implementations."""')
        lines.append(f'    ')
        lines.append(f'    def execute(self, mutation_input: {input_class}) -> {output_class}:')
        lines.append(f'        """Execute the {output_class} mutation."""')
        lines.append(f'        ...')
        lines.append('')
        lines.append('')

    # Write to file
    output_path.parent.mkdir(parents=True, exist_ok=True)
    with open(output_path, 'w') as f:
        f.write('\n'.join(lines))

    print(f"Generated protocol interfaces: {output_path}")
    print(f"Found {len(pairs)} mutation pairs:")
    for input_class, output_class in pairs:
        print(f"  - {input_class} -> {output_class}")


def main():
    project_root = Path(__file__).parent.parent
    mutations_yaml = project_root / 'def' / 'mutations.yml'
    output_file = project_root / 'mutations' / 'interfaces.py'

    schema = parse_mutations_yaml(mutations_yaml)
    generate_protocol_file(schema, output_file)


if __name__ == '__main__':
    main()
